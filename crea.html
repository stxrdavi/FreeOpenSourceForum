        }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow-y: auto; font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .container { position: relative; z-index: 2; width: 100%; min-height: 100vh; display: flex; justify-content: center; align-items: center; margin: 0 auto; padding: 40px 20px; box-sizing: border-box; }
        .container { position: relative; z-index: 2; width: 100%; min-height: 100vh; display: flex; justify-content: center; align-items: center; margin: 0 auto; padding: 40px 20px; box-sizing: border-box; transition: all 0.5s ease-in-out; }
        .glass-form { width: 100%; max-width: 600px; background: var(--form-background); border-radius: 40px; border: 1px solid var(--form-border); backdrop-filter: blur(15px) saturate(150%); -webkit-backdrop-filter: blur(15px) saturate(150%); padding: 40px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); transition: opacity 0.5s ease-out; }
        .form-header h1, .form-header h2 { margin: 0 0 20px 0; font-weight: 700; text-align: center; }
        .form-group { margin-bottom: 25px; }
@@ -38,7 +38,7 @@
        .btn:disabled { background-color: rgba(255, 255, 255, 0.5); color: rgba(0,0,0,0.4); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: var(--input-background); color: var(--text-color); }
        .btn-secondary:hover:not(:disabled) { background: rgba(255,255,255,0.25); }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; width: auto; }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; width: auto; text-decoration: none; display: inline-block; }
        .btn-danger { background: transparent; color: var(--danger-color); padding: 5px; width: auto; height: auto; font-size: 0.9rem; border: none; font-weight: 700; }
        .option-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .link-display { background: var(--input-background); padding: 15px 20px; border-radius: 20px; word-break: break-all; margin: 10px 0; text-align: left; font-size: 0.9rem; }
@@ -57,7 +57,6 @@
        .password-toggle-btn { position: absolute; top: 50%; right: 1px; transform: translateY(-50%); height: 48px; width: 48px; background: none; border: none; cursor: pointer; color: rgba(255, 255, 255, 0.6); display: flex; align-items: center; justify-content: center; }
        .password-toggle-btn:hover { color: white; }
        .password-toggle-btn svg { width: 22px; height: 22px; }
        
        #ai-toggle-btn { position: fixed; bottom: 30px; right: 30px; z-index: 1000; width: 60px; height: 60px; background: linear-gradient(45deg, var(--accent-color), #be9ff6); border-radius: 50%; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); transition: transform 0.3s ease; }
        #ai-toggle-btn:hover { transform: scale(1.1); }
        #ai-toggle-btn svg { width: 32px; height: 32px; color: white; }
@@ -76,7 +75,6 @@
        #ai-chat-input-form { display: flex; gap: 10px; padding: 15px; border-top: 1px solid var(--form-border); align-items: center; }
        #ai-chat-input { flex-grow: 1; height: 48px; border-radius: 24px; padding: 0 20px; }
        #ai-chat-submit { width: 48px; height: 48px; border-radius: 50%; flex-shrink: 0; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 1001; display: none; justify-content: center; align-items: center; }
        .modal-content { position: relative; background: var(--modal-bg); border: 1px solid var(--form-border); padding: 40px; border-radius: 25px; width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: rgba(255,255,255,0.6); font-size: 1.5rem; cursor: pointer; }
@@ -97,7 +95,7 @@
    <canvas id="particle-canvas"></canvas>
    <div class="container">
        <div id="main-content" style="display: none;">
            <div id="creator-section" class="glass-form">
            <div id="creator-section" class="glass-form" style="display: none;">
                <form id="forum-creator-form">
                    <div class="form-header"><h1>Crea il tuo Modulo</h1></div>
                    <div class="form-group"><label for="forum-title">Titolo del Modulo</label><input type="text" id="forum-title" placeholder="Es: Sondaggio del team" required></div>
@@ -139,7 +137,6 @@
            </div>
        </div>
    </div>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="modal-close-btn">&times;</button>
@@ -156,11 +153,12 @@
            <div class="switch-mode"><span id="switch-text">Non hai un account?</span><button id="switch-btn">Registrati</button></div>
        </div>
    </div>
    
    <button id="ai-toggle-btn" aria-label="Apri assistente AI"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443 48.282 48.282 0 005.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg></button>
    <div id="ai-chat-container"><div class="ai-chat-window"><div class="ai-chat-header"><h3>Assistente AI</h3><button class="close-btn" id="ai-close-btn">&times;</button></div><div class="ai-chat-messages" id="ai-chat-messages"><div class="chat-message ai-message">Ciao! Sono Sparky ✨ Come posso aiutarti a creare il tuo modulo?</div></div><form class="ai-chat-input-form" id="ai-chat-form"><input type="text" id="ai-chat-input" placeholder="Scrivi una domanda..." autocomplete="off" required><button type="submit" id="ai-chat-submit" aria-label="Invia messaggio"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg></button></form></div></div>

    <script>
        // --- SCRIPT COMPLETO ---
        // (Il codice JavaScript è completo e non omesso)
        const SUPABASE_URL = 'https://xvjjnpwatfpjceqqkraz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2ampucHdhdGZwamNlcXFrcmF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwMDkwNDgsImV4cCI6MjA2NTU4NTA0OH0.Lt0m8t4o8UZdSGV9kjMT0i4bahqoA2NOJHG-2ueE6g8';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
@@ -206,6 +204,8 @@
                    } else {
                        creatorSection.style.display = 'block';
                        viewerSection.style.display = 'none';
                        creatorConfirmationSection.style.display = 'none';
                        viewerConfirmationSection.style.display = 'none';
                        setupCreatorEventListeners(user);
                    }
                } else {
@@ -348,126 +348,126 @@
            }
        }

        async function loadForum(id) {
        async function loadForum(id, user) {
            try {
                const { data, error } = await supabaseClient.from('forums').select('*').eq('id', id).single();
                if (error || !data) throw new Error("Modulo non trovato.");

                creatorSection.style.display = 'none';
                viewerSection.style.display = 'block';
                document.getElementById('viewer-title').textContent = data.title;

                const questionsContainer = document.getElementById('viewer-questions-container');
                questionsContainer.innerHTML = '';
                data.questions.forEach((q, index) => {
                    const questionBlock = document.createElement('div');
                    questionBlock.className = 'form-group question-block';
                    const optionsHTML = q.options.map(opt => `<label><input type="radio" name="scelta_${index}" value="${opt}" required><span>${opt}</span></label>`).join('');
                    questionBlock.innerHTML = `<label>${q.text}</label><div class="radio-group">${optionsHTML}</div>`;
                    questionsContainer.appendChild(questionBlock);
                });

                setupViewerValidation(id, data.questions.length);

            } catch(error) {
                creatorSection.innerHTML = `<h2>Oops!</h2><p>${error.message}</p><a href="/" class="btn">Torna alla creazione</a>`;
                creatorSection.style.textAlign = 'center';
            }
        }

        function setupViewerValidation(forumId, questionCount) {
            const nameInput = document.getElementById('viewer-name');
            const submitBtn = document.getElementById('submit-answer-btn');
            const form = document.getElementById('forum-viewer-form');
            const errorMessage = document.getElementById('viewer-error-message');

            const validate = () => {
                const nameValid = nameInput.value.trim() !== '';
                const answers = document.querySelectorAll('input[type="radio"]:checked');
                submitBtn.disabled = !(nameValid && answers.length === questionCount);
            };

            form.addEventListener('change', validate);
            nameInput.addEventListener('input', validate);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitBtn.disabled = true;
                errorMessage.style.display = 'none';

                const name = nameInput.value;
                const answersData = Array.from(document.querySelectorAll('#viewer-questions-container .question-block')).map((block, index) => {
                    const questionText = block.querySelector('label').textContent;
                    const choice = block.querySelector(`input[name="scelta_${index}"]:checked`).value;
                    return { question: questionText, answer: choice };
                });

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFont("helvetica", "bold");
                    doc.text(`Risposte per il modulo: ${document.getElementById('viewer-title').textContent}`, 10, 20);
                    doc.setFont("helvetica", "normal");
                    doc.text(`Inviato da: ${name}`, 10, 30);
                    let yPos = 50;
                    answersData.forEach(item => {
                        if (yPos > 280) { doc.addPage(); yPos = 20; }
                        doc.setFont("helvetica", "bold");
                        doc.text(item.question, 10, yPos);
                        yPos += 7;
                        doc.setFont("helvetica", "normal");
                        doc.text(`- ${item.answer}`, 15, yPos);
                        yPos += 15;
                    });
                    const pdfBlob = doc.output('blob');
                    const fileName = `forum_${forumId}/${name.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
                    const { error } = await supabaseClient.storage.from('answers').upload(fileName, pdfBlob, { contentType: 'application/pdf' });
                    if (error) throw error;
                    viewerSection.style.display = 'none';
                    viewerConfirmationSection.style.display = 'block';
                } catch (error) {
                    console.error("Errore invio risposta:", error);
                    if (error.message.toLowerCase().includes('failed to fetch')) {
                        errorMessage.textContent = "Errore di rete. Impossibile inviare la risposta.";
                    } else {
                        errorMessage.textContent = "Errore: " + error.message;
                    }
                    errorMessage.style.display = 'block';
                    submitBtn.disabled = false;
                }
            });
        }

        function setupAIChat() {
            const aiToggleBtn = document.getElementById('ai-toggle-btn');
            const aiChatContainer = document.getElementById('ai-chat-container');
            const aiChatForm = document.getElementById('ai-chat-form');
            const aiChatInput = document.getElementById('ai-chat-input');
            const aiChatMessages = document.getElementById('ai-chat-messages');
            const aiCloseBtn = document.getElementById('ai-close-btn');

            if(aiToggleBtn) aiToggleBtn.addEventListener('click', () => { aiChatContainer.classList.add('visible'); aiChatInput.focus(); });
            if(aiCloseBtn) aiCloseBtn.addEventListener('click', () => aiChatContainer.classList.remove('visible'));
            if(aiChatContainer) aiChatContainer.addEventListener('click', (e) => { if (e.target === aiChatContainer) aiChatContainer.classList.remove('visible'); });
            if(aiChatForm) aiChatForm.addEventListener('submit', (e) => { e.preventDefault(); const msg = aiChatInput.value.trim(); if(msg){ addMessage(msg, 'user'); aiChatInput.value = ''; getAiResponse(msg); } });

            function addMessage(text, sender) { const el = document.createElement('div'); el.className = `chat-message ${sender}-message`; el.textContent = text; aiChatMessages.appendChild(el); aiChatMessages.scrollTop = aiChatMessages.scrollHeight; return el; }
            function typeMessage(el, text) { el.textContent = ''; let i = 0; function typing() { if(i < text.length) { el.textContent += text.charAt(i++); setTimeout(typing, 30); } } typing(); }

            async function getAiResponse(prompt) {
                const loadingEl = addMessage("...", 'ai');
                const apiKey = "AIzaSyCyllM7dVlaX0jwRAt8cjIypCpF3u3uBBc";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const systemInstruction = "Sei Sparky, un assistente AI per il sito FreeOpenSourceModule. Il tuo unico scopo è aiutare gli utenti a capire come usare il sito per creare e rispondere ai moduli. Rispondi SOLO a domande relative a queste funzionalità. Se ti viene chiesto altro, come chi ti ha creato o argomenti non pertinenti, rispondi gentilmente che non puoi fornire quel tipo di informazione. Sii conciso, amichevole e usa emoji. 😊";
                try {
                    const res = await fetch(apiUrl, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: `${systemInstruction}\nUtente: "${prompt}"` }] }] }) });
                    if (!res.ok) throw new Error("Errore API");
                    const data = await res.json();
                    const aiText = data.candidates[0].content.parts[0].text;
                    typeMessage(loadingEl, aiText);
                } catch (e) { typeMessage(loadingEl, "Oops, c'è un problema di rete. 😥"); }
            }
        }
    </script>
</body>
</html>
